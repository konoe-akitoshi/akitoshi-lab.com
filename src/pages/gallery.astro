---
import Layout from "../layouts/Layout.astro";
import type { ImageMetadata } from "astro";
import GalleryComponent from "../components/svelte/Gallery.svelte";

// 画像ファイルを動的にインポート
import { getImage } from "astro:assets";
const imageFiles = import.meta.glob<{ default: ImageMetadata }>('../assets/img/gallery/*', { eager: true });

// 画像データを作成し、重複を排除
const images = await Promise.all(
  Object.entries(imageFiles).map(async ([path, module]) => {
    const filename = path.split('/').pop() || '';
    const title = filename.replace(/\.[^/.]+$/, "");
    // サムネイル用に最適化
    const thumb = await getImage({ src: module.default, width: 320, quality: 40 });
    return {
      thumb: thumb.src,
      full: module.default.src,
      alt: `Gallery image ${filename}`,
      title
    };
  })
);

// 一意の画像を確保してランダムに並び替え
const uniqueImages = Array.from(new Set(images.map(img => img.full)))
  .map(full => images.find(img => img.full === full))
  .filter((img): img is typeof images[0] => img !== undefined);

const shuffledImages = [...uniqueImages].sort(() => Math.random() - 0.5);
---

<Layout
  title="Gallery | Akitoshi Lab."
  description="様々な作品を展示しています。"
  ogImage="/img/OGP.webp"
  bodyClass="m-0 p-0 font-sans overflow-x-hidden bg-background text-text"
  useMainWrapper={false}
>
  <div class="gallery-page p-y-12 p-x-0">
    <div class="gallery-header pt-8 pb-12 text-center">
      <h2 class="text-base font-normal uppercase tracking-wider mb-6 gallery-title">GALLERY</h2>
    </div>
    
    <GalleryComponent client:load images={shuffledImages} />
  </div>
</Layout>

<style>
  .gallery-page {
    width: 100%;
    min-height: 100vh;
  }
</style>
